---
- name: Check route to server(s)
  hosts: all
  become: True
  gather_facts: false
  tasks:
    - command: "lnetctl ping {{ hostvars[item]['ansible_host'] }}@{{ hostvars[item]['lnet_eth0_net_type'] }}"
      changed_when: False
      loop: "{{ groups['lustre_server'] }}"

- name: Check route from server(s) to clients/routers
  # NB: is this redundant given ping uses both out and back routes? Documents approach at least.
  hosts: lustre_server
  become: True
  gather_facts: false
  tasks:
    - command: "lnetctl ping {{ hostvars[item]['ansible_host'] }}@{{ hostvars[item]['lnet_eth0_net_type'] }}"
      changed_when: False
      loop: "{{ groups['lustre_client'] }}"

- name: Check clients in different lnets *cannot* access each other
  hosts: lustre_client
  become: True
  gather_facts: false
  tasks:
    - command: "lnetctl ping {{ hostvars[item]['ansible_host'] }}@{{ hostvars[item]['lnet_eth0_net_type'] }}"
      register: result
      when: "hostvars[item].lnet_eth0_net_type != lnet_eth0_net_type"
      failed_when: 'result.rc == 0'
      changed_when: False
      loop: "{{ groups['lustre_client']  | difference([inventory_hostname]) }}" # remove current host from list to check