---
# also needs mount_state
# document what's currently provided from group_vars here
# for project user/group names/guids:
  # projects[item].base
  # projects.keys()
# for mount:
  # lustre.mount_point
  # lustre.mgs_addr
  # lustre.mgs_lnet
  # lustre.fs_name
# for lnet:
  # TODO:
- name: enable lustre client repo
  yum_repository:
    name: lustre-client
    description: lustre-client
    file: lustre-repo
    baseurl: https://downloads.whamcloud.com/public/lustre/lustre-{{ lustre.release }}/el7/client
    gpgcheck: no
- name: ensure kernel headers available
  package:
    # EPEL needed to install dkms
    name: kernel-devel,epel-release
- name: Install Lustre Client DKMS
  yum:
    name: "lustre-client-dkms-{{ lustre.release }}"
    state: present
- name: Install Lustre Client kmods
  yum:
    name: "kmod-lustre-client-{{ lustre.release }}"
    state: present
- name: Install Lustre Client
  yum:
    name: "lustre-client-{{ lustre.release }}"
    state: present
- name: Put SELinux in permissive mode, logging actions that would be blocked.
  selinux:
    policy: targeted
    state: permissive
- name: configure and enable lnet
  import_tasks: lnet.yml

- name: raise client GSS key debug level
  command:
    cmd: "lctl set_param sptlrpc.gss.lgss_keyring.debug_level{{'='}}3"
    removes: "/etc/lustre{{ inventory_hostname | replace('-', '_') }}.client.key }}" # doesn't actually remove, but skips if not using ssk
  # TODO: not convinced this works, try
  # "echo 3 > /proc/fs/lustre/sptlrpc/gss/lgss_keyring/debug_level" instead

- name: create lustre config directory
  # NB: done even if not using ssk as can always mount with -o skpath=/etc/lustre, it just won't load any keys if it's empty.
  file:
    path: /etc/lustre
    state: directory
    mode: 0600
  

